USE MASTER
CREATE DATABASE	QuanLyBaiGiuXe

GO

USE QuanLyBaiGiuXe

GO

CREATE FUNCTION AUTO_IDLV()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MALV) FROM LOAIVE) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MALV, 3)) FROM LOAIVE
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'LV00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'LV0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

CREATE TABLE LoaiVe
(
	MALV CHAR(5) PRIMARY KEY CONSTRAINT IDLV DEFAULT DBO.AUTO_IDLV(),
	TENLV NVARCHAR(30) NOT NULL,
)

GO

CREATE PROC select_LV
as
	SELECT * FROM [dbo].[LoaiVe]

GO

CREATE FUNCTION AUTO_IDKV()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MAKV) FROM KHUVUC) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MAKV, 3)) FROM KHUVUC
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'KV00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'KV0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

CREATE TABLE KhuVuc
(
	MAKV CHAR(5) PRIMARY KEY CONSTRAINT IDKV DEFAULT DBO.AUTO_IDKV(),
	TENKV NVARCHAR(30) NOT NULL,
)

GO

CREATE PROC select_KV
as
	SELECT * FROM [dbo].[KhuVuc]

GO

CREATE FUNCTION AUTO_IDVT()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MAVT) FROM VITRI) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MAVT, 3)) FROM VITRI
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'VT00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'VT0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

CREATE TABLE ViTri
(
	MAVT CHAR(5) PRIMARY KEY CONSTRAINT IDVT DEFAULT DBO.AUTO_IDVT(),
	TENVT NVARCHAR(30) NOT NULL,
	MAKV CHAR(5) NOT NULL,
	CONSTRAINT fk_MaKhuVuc
	FOREIGN KEY(MAKV)
	REFERENCES KHUVUC(MAKV)
	ON DELETE CASCADE ON UPDATE CASCADE,
)

GO

CREATE PROC select_VT
as
	SELECT * FROM [dbo].[ViTri]

GO


CREATE FUNCTION AUTO_IDVeNgay()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MAVE) FROM VENGAY) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MAVE, 3)) FROM VENGAY
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'VN00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'VN0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO 

CREATE TABLE VeNgay
(
	MAVE CHAR(5) PRIMARY KEY CONSTRAINT IDVeNgay DEFAULT DBO.AUTO_IDVeNgay(),
	LOAIXE NVARCHAR(30) NOT NULL,
	BIENSO NVARCHAR(30) NOT NULL,
	MAUXE NVARCHAR(30) NOT NULL,
	NGAYNHAN DATE,
	GIONHAN NVARCHAR(50) NOT NULL,
	NGAYTRA DATE,
	GIOTRA NVARCHAR(50),
	MALV CHAR(5),
	CONSTRAINT fk_MaLoaiVe
	FOREIGN KEY(MALV)
	REFERENCES LOAIVE(MALV)
	ON DELETE CASCADE ON UPDATE CASCADE,
	MAKV CHAR(5),
	CONSTRAINT fk_MaKhuVucGui
	FOREIGN KEY(MAKV)
	REFERENCES KHUVUC(MAKV)
	ON DELETE CASCADE ON UPDATE CASCADE,
	MAVT CHAR(5)
)

GO

CREATE PROC select_VN
as
	SELECT * FROM [dbo].[VeNgay]


GO


CREATE FUNCTION AUTO_IDVeThang()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MAVE) FROM VETHANG) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MAVE, 3)) FROM VETHANG
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'VT00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'VT0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO 

CREATE TABLE VeThang
(
	MAVE CHAR(5) PRIMARY KEY CONSTRAINT IDVeThang DEFAULT DBO.AUTO_IDVeThang(),
	LOAIXE NVARCHAR(30) NOT NULL,
	BIENSO NVARCHAR(30) NOT NULL,
	MAUXE NVARCHAR(30) NOT NULL,
	NGAYNHAN DATE,
	GIONHAN NVARCHAR(50) NOT NULL,
	NGAYTRA DATE,
	GIOTRA NVARCHAR(50),
	MALV CHAR(5),
	CONSTRAINT fk_MaLoaiVeThang
	FOREIGN KEY(MALV)
	REFERENCES LOAIVE(MALV)
	ON DELETE CASCADE ON UPDATE CASCADE,
	MAKV CHAR(5),
	MAVT CHAR(5),
	TENKH NVARCHAR(30),
	SODIENTHOAI NVARCHAR(30),
	NGAYDANGKY DATE
)

GO

CREATE PROC select_VeThang
as
	SELECT * FROM [dbo].[VeThang]


GO

INSERT INTO [dbo].[LoaiVe]([TENLV]) VALUES (N'Vé Ngày')
INSERT INTO [dbo].[LoaiVe]([TENLV]) VALUES (N'Vé Tháng')

INSERT INTO [dbo].[KhuVuc]([TENKV]) VALUES (N'Khu Vực A');
INSERT INTO [dbo].[KhuVuc]([TENKV]) VALUES (N'Khu Vực B');
INSERT INTO [dbo].[KhuVuc]([TENKV]) VALUES (N'Khu Vực C');
INSERT INTO [dbo].[KhuVuc]([TENKV]) VALUES (N'Khu Vực D');
INSERT INTO [dbo].[KhuVuc]([TENKV]) VALUES (N'Khu Vực E');
INSERT INTO [dbo].[KhuVuc]([TENKV]) VALUES (N'Khu Vực F');

INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A01')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A02')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A03')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A04')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A05')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A06')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A07')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A08')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A09')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV001', N'A10')

INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B01')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B02')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B03')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B04')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B05')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B06')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B07')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B08')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B09')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV002', N'B10')

INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV003', N'C01')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV003', N'C02')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV003', N'C03')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV003', N'C04')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV003', N'C05')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV003', N'C06')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV003', N'C07')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV003', N'C08')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV003', N'C09')

INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D01')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D02')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D03')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D04')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D05')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D06')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D07')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D08')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D09')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV004', N'D10')

INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E01')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E02')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E03')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E04')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E05')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E06')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E07')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E08')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E09')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV005', N'E10')

INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F01')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F02')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F03')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F04')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F05')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F06')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F07')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F08')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F09')
INSERT INTO [dbo].[ViTri]([MAKV],[TENVT]) VALUES ('KV006', N'F10')

